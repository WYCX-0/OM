{"version":3,"file":"websocket.js","sources":["utils/websocket.js"],"sourcesContent":["// utils/websocket.js\r\n\r\nlet isSocketClose = false;\r\nlet reconnectCount = 60;\r\nlet heartbeatInterval = null;\r\nlet socketTask = null;\r\nlet againTimer = null;\r\n\r\n// 全局消息监听回调\r\nlet globalMessageHandler = null;\r\n\r\nlet currentConnectParams = {\r\n\turl: '',\r\n\ttoken: ''\r\n};\r\n\r\nexport const websocketObj = {\r\n\tconnect,\r\n\tclose: stop,\r\n\tsendMsg,\r\n\tsetMessageHandler: (handler) => {\r\n\t\tglobalMessageHandler = handler;\r\n\t}\r\n};\r\n\r\nfunction connect(url, token = '') {\r\n\tif (socketTask && socketTask.readyState === 1) return; // 检查状态为 OPEN（1）\r\n\r\n\tisSocketClose = false;\r\n\tcurrentConnectParams = {\r\n\t\turl: '',\r\n\t\ttoken: ''\r\n\t};\r\n\r\n\t// 清理旧连接\r\n\tif (socketTask) {\r\n\t\tstop();\r\n\t}\r\n\r\n\tsocketTask = uni.connectSocket({\r\n\t\turl: url,\r\n\t\theader: {\r\n\t\t\t'Authorization': `Bearer ${token}`\r\n\t\t},\r\n\t\tsuccess: () => console.log(\"WebSocket 连接中...\"),\r\n\t\tfail: (err) => console.error(\"连接失败:\", err)\r\n\t});\r\n\r\n\tsocketTask.onOpen(() => {\r\n\t\tconsole.log('WebSocket 已打开');\r\n\t\tstartHeartbeat();\r\n\t\tuni.$emit('websocket-connected'); // 全局事件通知\r\n\t});\r\n\r\n\tsocketTask.onMessage((res) => {\r\n\t\tconsole.log('收到消息:', res.data);\r\n\t\tif (globalMessageHandler) {\r\n\t\t\tglobalMessageHandler(res.data);\r\n\t\t}\r\n\t\t// 触发全局弹窗\r\n\t\tuni.showModal({\r\n\t\t\ttitle: '新消息',\r\n\t\t\tcontent: res.data,\r\n\t\t\tshowCancel: false\r\n\t\t});\r\n\t});\r\n\r\n\tsocketTask.onError((err) => {\r\n\t\tconsole.error('连接错误:', err);\r\n\t\tif (!isSocketClose) reconnect(url);\r\n\t});\r\n\r\n\tsocketTask.onClose(() => {\r\n\t\tconsole.log('连接已关闭');\r\n\t\tif (!isSocketClose) reconnect(url);\r\n\t});\r\n}\r\n\r\nfunction startHeartbeat() {\r\n\theartbeatInterval = setInterval(() => {\r\n\t\tsendMsg(JSON.stringify({\r\n\t\t\ttype: 'heartbeat'\r\n\t\t}));\r\n\t}, 60000);\r\n}\r\n\r\nfunction sendMsg(msg) {\r\n\tif (socketTask && socketTask.readyState === 1) { // 检查状态为 OPEN（1）\r\n\t\tsocketTask.send({\r\n\t\t\tdata: msg\r\n\t\t});\r\n\t}\r\n}\r\n\r\nfunction stop() {\r\n\tisSocketClose = true;\r\n\tclearInterval(heartbeatInterval);\r\n\tclearTimeout(againTimer);\r\n\tif (socketTask) {\r\n\t\tsocketTask.close();\r\n\t\tsocketTask = null;\r\n\t}\r\n}\r\n\r\nfunction reconnect(url) {\r\n\tif (reconnectCount <= 0) return;\r\n\treconnectCount--;\r\n\r\n\tagainTimer = setTimeout(() => {\r\n\t\tconsole.log('尝试重连...');\r\n\t\tconnect(url);\r\n\t}, 5000);\r\n}"],"names":["uni"],"mappings":";;AAEA,IAAI,gBAAgB;AACpB,IAAI,iBAAiB;AACrB,IAAI,oBAAoB;AACxB,IAAI,aAAa;AACjB,IAAI,aAAa;AAGjB,IAAI,uBAAuB;AAOf,MAAC,eAAe;AAAA,EAC3B;AAAA,EACA,OAAO;AAAA,EACP;AAAA,EACA,mBAAmB,CAAC,YAAY;AAC/B,2BAAuB;AAAA,EACvB;AACF;AAEA,SAAS,QAAQ,KAAK,QAAQ,IAAI;AACjC,MAAI,cAAc,WAAW,eAAe;AAAG;AAE/C,kBAAgB;AAOhB,MAAI,YAAY;AACf;EACA;AAED,eAAaA,cAAG,MAAC,cAAc;AAAA,IAC9B;AAAA,IACA,QAAQ;AAAA,MACP,iBAAiB,UAAU,KAAK;AAAA,IAChC;AAAA,IACD,SAAS,MAAMA,cAAAA,MAAY,MAAA,OAAA,4BAAA,kBAAkB;AAAA,IAC7C,MAAM,CAAC,QAAQA,oBAAA,MAAA,SAAA,4BAAc,SAAS,GAAG;AAAA,EAC3C,CAAE;AAED,aAAW,OAAO,MAAM;AACvBA,kBAAAA,MAAY,MAAA,OAAA,4BAAA,eAAe;AAC3B;AACAA,wBAAI,MAAM,qBAAqB;AAAA,EACjC,CAAE;AAED,aAAW,UAAU,CAAC,QAAQ;AAC7BA,iEAAY,SAAS,IAAI,IAAI;AAC7B,QAAI,sBAAsB;AACzB,2BAAqB,IAAI,IAAI;AAAA,IAC7B;AAEDA,kBAAAA,MAAI,UAAU;AAAA,MACb,OAAO;AAAA,MACP,SAAS,IAAI;AAAA,MACb,YAAY;AAAA,IACf,CAAG;AAAA,EACH,CAAE;AAED,aAAW,QAAQ,CAAC,QAAQ;AAC3BA,kBAAc,MAAA,MAAA,SAAA,4BAAA,SAAS,GAAG;AAC1B,QAAI,CAAC;AAAe,gBAAU,GAAG;AAAA,EACnC,CAAE;AAED,aAAW,QAAQ,MAAM;AACxBA,kBAAAA,MAAY,MAAA,OAAA,4BAAA,OAAO;AACnB,QAAI,CAAC;AAAe,gBAAU,GAAG;AAAA,EACnC,CAAE;AACF;AAEA,SAAS,iBAAiB;AACzB,sBAAoB,YAAY,MAAM;AACrC,YAAQ,KAAK,UAAU;AAAA,MACtB,MAAM;AAAA,IACN,CAAA,CAAC;AAAA,EACF,GAAE,GAAK;AACT;AAEA,SAAS,QAAQ,KAAK;AACrB,MAAI,cAAc,WAAW,eAAe,GAAG;AAC9C,eAAW,KAAK;AAAA,MACf,MAAM;AAAA,IACT,CAAG;AAAA,EACD;AACF;AAEA,SAAS,OAAO;AACf,kBAAgB;AAChB,gBAAc,iBAAiB;AAC/B,eAAa,UAAU;AACvB,MAAI,YAAY;AACf,eAAW,MAAK;AAChB,iBAAa;AAAA,EACb;AACF;AAEA,SAAS,UAAU,KAAK;AACvB,MAAI,kBAAkB;AAAG;AACzB;AAEA,eAAa,WAAW,MAAM;AAC7BA,kBAAAA,MAAA,MAAA,OAAA,6BAAY,SAAS;AACrB,YAAQ,GAAG;AAAA,EACX,GAAE,GAAI;AACR;;"}